<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Box Breathing</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      transition: background-color 1.5s ease;
    }

    :root {
      --bg: linear-gradient(135deg, #e8756a 0%, #c0548e 40%, #8b5fbf 70%, #6a82d1 100%);
      --square-border: rgba(255, 255, 255, 0.6);
      --orb-gradient: radial-gradient(circle at 50% 50%, #ffb347 0%, #e8856e 35%, #d4688e 65%, transparent 100%);
      --orb-glow-rgb: 255, 160, 80;
      --bean-fill: white;
      --bean-glow: rgba(255, 255, 255, 0.6);
      --label-color: rgba(255, 255, 255, 0.9);
    }

    :root.night {
      --bg: linear-gradient(135deg, #1a0a0a 0%, #2d1420 30%, #3a1a2e 60%, #1e1028 100%);
      --square-border: rgba(255, 255, 255, 0.6);
      --orb-gradient: radial-gradient(circle at 50% 50%, #c47a30 0%, #8b4530 35%, #5a2838 65%, transparent 100%);
      --orb-glow-rgb: 180, 100, 40;
      --bean-fill: white;
      --bean-glow: rgba(255, 255, 255, 0.6);
      --label-color: rgba(255, 255, 255, 0.85);
    }

    .star {
      position: fixed;
      opacity: 0;
      animation: twinkle-in 1s ease forwards;
    }

    @keyframes twinkle-in {
      0% { opacity: 0; transform: scale(0); }
      50% { opacity: 1; transform: scale(1.5); }
      100% { opacity: 0.8; transform: scale(1); }
    }

    .container {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .box-wrapper {
      position: relative;
      width: min(250px, 60vmin);
      height: min(250px, 60vmin);
    }

    .square {
      position: absolute;
      inset: 0;
      border: 2px solid var(--square-border);
      border-radius: 2px;
    }

    .orb {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 60%;
      height: 60%;
      transform: translate(-50%, -50%) scale(0.5);
      border-radius: 50%;
      background: var(--orb-gradient);
      will-change: transform, box-shadow;
    }

    .dot {
      position: absolute;
      width: 24px;
      height: 18px;
      margin-left: -12px;
      margin-top: -9px;
      will-change: left, top, transform;
      filter: drop-shadow(0 0 4px var(--bean-glow));
    }

    .label {
      margin-top: 32px;
      color: var(--label-color);
      font-size: clamp(16px, 3vmin, 20px);
      font-weight: 300;
      letter-spacing: 0.08em;
      text-align: center;
      transition: opacity 0.4s ease;
      min-height: 1.4em;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="box-wrapper">
      <div class="square"></div>
      <div class="orb" id="orb"></div>
      <svg id="dot" class="dot" viewBox="0 0 100 80" xmlns="http://www.w3.org/2000/svg">
        <path d="M 30,12 C 12,8 5,28 10,48 C 15,68 38,80 60,75 C 82,70 98,52 92,32 C 86,18 72,16 62,26 C 52,14 40,8 30,12 Z" fill="var(--bean-fill)"/>
      </svg>
    </div>
    <div class="label" id="label"></div>
  </div>

  <script>
    // Night mode: 8pm – 6am
    var glowRgb = '';
    function applyTheme() {
      var h = new Date().getHours();
      document.documentElement.classList.toggle('night', h >= 20 || h < 6);
      glowRgb = getComputedStyle(document.documentElement).getPropertyValue('--orb-glow-rgb').trim();
    }
    applyTheme();
    setInterval(applyTheme, 60000);

    const CYCLE_MS = 16000;
    const SIDE_MS = 4000;
    const PHASES = ['Breathe in', 'Hold', 'Breathe out', 'Hold'];

    const dot = document.getElementById('dot');
    const orb = document.getElementById('orb');
    const label = document.getElementById('label');

    let currentPhaseIndex = -1;
    var lastCycle = Math.floor(Date.now() / CYCLE_MS);

    function spawnStar() {
      var size = 8 + Math.random() * 6;
      var ns = 'http://www.w3.org/2000/svg';
      var svg = document.createElementNS(ns, 'svg');
      svg.setAttribute('viewBox', '0 0 100 100');
      svg.setAttribute('width', size);
      svg.setAttribute('height', size);
      svg.classList.add('star');
      svg.style.left = (Math.random() * 100) + 'vw';
      svg.style.top = (Math.random() * 100) + 'vh';

      var defs = document.createElementNS(ns, 'defs');
      var filter = document.createElementNS(ns, 'filter');
      filter.id = 'g' + Date.now();
      var blur = document.createElementNS(ns, 'feGaussianBlur');
      blur.setAttribute('stdDeviation', '4');
      filter.appendChild(blur);
      defs.appendChild(filter);
      svg.appendChild(defs);

      // 4-point star: narrow diamond spikes with a tiny center
      var path = document.createElementNS(ns, 'path');
      path.setAttribute('d', 'M 50,0 L 56,38 100,50 56,62 50,100 44,62 0,50 44,38 Z');
      path.setAttribute('fill', 'white');
      path.setAttribute('filter', 'url(#' + filter.id + ')');
      svg.appendChild(path);

      document.body.appendChild(svg);
    }

    function easeInOut(t) {
      return t < 0.5
        ? 4 * t * t * t
        : 1 - Math.pow(-2 * t + 2, 3) / 2;
    }

    function update() {
      const phase = Date.now() % CYCLE_MS;
      const sideIndex = Math.floor(phase / SIDE_MS);
      const t = (phase % SIDE_MS) / SIDE_MS;

      // Position the dot along the square perimeter (clockwise from top-left)
      let x, y;
      switch (sideIndex) {
        case 0: // Top: left → right
          x = t;
          y = 0;
          break;
        case 1: // Right: top → bottom
          x = 1;
          y = t;
          break;
        case 2: // Bottom: right → left
          x = 1 - t;
          y = 1;
          break;
        case 3: // Left: bottom → top
          x = 0;
          y = 1 - t;
          break;
      }

      // Rotate bean to face direction of travel
      var rotation = [0, 90, 180, 270][sideIndex];
      dot.style.left = (x * 100) + '%';
      dot.style.top = (y * 100) + '%';
      dot.style.transform = 'rotate(' + rotation + 'deg) scaleY(-1)';

      // Orb scale: 0.5 (small) ↔ 1.0 (large)
      let scale;
      switch (sideIndex) {
        case 0: // Breathe in: grow 0.5 → 1.0
          scale = 0.5 + 0.5 * easeInOut(t);
          break;
        case 1: // Hold: stay large
          scale = 1.0;
          break;
        case 2: // Breathe out: shrink 1.0 → 0.5
          scale = 1.0 - 0.5 * easeInOut(t);
          break;
        case 3: // Hold: stay small
          scale = 0.5;
          break;
      }

      orb.style.transform = 'translate(-50%, -50%) scale(' + scale + ')';

      // Glow intensity follows scale
      const glowOpacity = 0.15 + 0.35 * ((scale - 0.5) / 0.5);
      const glowSize = 10 + 30 * ((scale - 0.5) / 0.5);
      orb.style.boxShadow = '0 0 ' + (40 + glowSize) + 'px ' + (10 + glowSize) + 'px rgba(' + glowRgb + ', ' + glowOpacity + ')';

      // Spawn a star each full cycle in night mode
      var currentCycle = Math.floor(Date.now() / CYCLE_MS);
      if (currentCycle !== lastCycle) {
        lastCycle = currentCycle;
        if (document.documentElement.classList.contains('night')) {
          spawnStar();
        }
      }

      // Update label only when phase changes
      if (sideIndex !== currentPhaseIndex) {
        currentPhaseIndex = sideIndex;
        label.style.opacity = '0';
        setTimeout(function () {
          label.textContent = PHASES[sideIndex];
          label.style.opacity = '1';
        }, 200);
      }

      requestAnimationFrame(update);
    }

    requestAnimationFrame(update);
  </script>
</body>
</html>
